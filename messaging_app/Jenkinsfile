pipeline {
    agent any 
        stages {
           stage('Build') {
                steps {
                    echo 'Building...'
                    // Checkout with GitHub credentials
                    git branch: 'main',
                        url: 'https://github.com/Limah-T/alx-backend-python.git',
                        credentialsId: 'github-creds'

                    // Install dependencies inside Python virtualenv
                    pythonEnv('python3') {
                        echo 'Installing dependencies...'
                        sh 'pip3 install -r messaging_app/requirements.txt'
                    }
                }
            }

            stage('Build Docker Image') {
                steps {
                    script {
                        // Build the Docker image
                        def appImage = docker.build("limtech001/messaging_app:${env.BUILD_ID}", "-f messaging_app/Dockerfile .")

                        // Push to DockerHub
                        docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-creds') {
                            echo 'Pushing Docker image to Docker Hub...'
                            appImage.push()          // Push BUILD_ID tag
                            appImage.push("latest")  // Push 'latest' tag
                            appImage.push("v1.0")    // Push versioned tag
                        }
                    }
                }
            }

            stage('Test') {
                steps {
                    pythonEnv('python3') {
                        echo 'Running tests with pytest...'
                        sh 'pytest messaging_app/ --junitxml=report.xml'
                    }
                }
                post {
                    always {
                        junit 'report.xml'  // publish test results in Jenkins UI
                    }
                }
            }

            stage('Deploy') {
                steps {
                    echo 'Deploying...'
                    echo "About to deploy the messaging_app"
                    sh 'kubectl apply -f deployment.yaml'
                    echo "Getting pods..."
                    sh 'kubectl get pods'
                }
            }
        }    
}
